\ctikzsubcircuitdef{subctkmsFlipFlop} {
    d, rst, reclk, feclk, q, qbar,
    bd, brst, breclk, bfeclk, bq, bqbar%
} {
    node (#1) [msFlipFlop, anchor = lpin 1]{}%
    \markcoordinate {#1} {d}     {lpin 2}
    \markcoordinate {#1} {rst}   {bpin 2}
    \markcoordinate {#1} {reclk}  {tpin 1}
    \markcoordinate {#1} {feclk} {tpin 2}
    \markcoordinate {#1} {q}     {rpin 1}
    \markcoordinate {#1} {qbar}  {rpin 2}%
    (#1-bd) node[circleinv, fill = circleinvfillcolor, anchor = apex] {}
    (#1-breclk) node[circleinv, fill = circleinvfillcolor, anchor = bottom] {}
    (#1-bfeclk) node[circleinv, fill = circleinvfillcolor, anchor = bottom] {}
    (#1-bqbar) node[circleinv, fill = circleinvfillcolor, anchor = left] {}
}

\ctikzsubcircuitactivate{subctkmsFlipFlop}

\newcommand\msFlipFlop[3] {
    \subctkmsFlipFlop{#1} {#2}
    (#1.center) node[]{#3}
}

\ctikzsubcircuitdef{subctkedgeDetector} {
    clk, reclk,
    bclk, breclk%
} {
    node (#1) [edgeDetector, anchor = lpin 1]{}%
    \markcoordinate {#1} {clk}     {lpin 1}
    \markcoordinate {#1} {reclk}   {rpin 1}
    (#1-breclk) node[circleinv, fill = circleinvfillcolor, anchor = left] {}
}

\ctikzsubcircuitactivate{subctkedgeDetector}

\newcommand\edgeDetector[3] {
    \subctkedgeDetector{#1} {#2}
    (#1.center) node[]{#3}
}

\ctikzsubcircuitdef{subctkgLvlSRLatch} {
    s, r, q, qbar,
    bs, br, bq, bqbar%
} {
    coordinate (#1-q)
    %%
    ++(-1,0)
    node (#1-nor1) [nor port, anchor = out] {}
    %%
    (#1-nor1.in 2)
    ++(0,-3)
    %%
    node (#1-nor2) [nor port, anchor = in 1] {}
    %%
    %% Markings for cross coupling
    %%
    ($(#1-nor1.in 2)!0.50!(#1-nor2.in 1)$)
    ++(-0.75,0)
    coordinate (#1-invrt)
    %%
    (#1-nor1.out)
    ++(0.5,0)
    coordinate (#1-outvrt)
    %%
    (#1-nor1.in 2)
    coordinate (#1-ccfbvrt)
    %%
    (#1-nor1.in 2-|#1-ccfbvrt)
    ++ (0,-1.25)
    coordinate (#1-ccfbabove)
    %%
    (#1-nor2.in 1-|#1-ccfbabove)
    ++ ($(#1-nor1.in 2-|#1-ccfbvrt)-(#1-ccfbabove)$)
    coordinate (#1-ccfbbelow)
    %%
    %%
    %% Drawing the cross coupling
    %%
    (#1-nor1.in 2)
    \constcornerleft {(#1-nor2.in 1-|#1-invrt)}
    \varcornerdownright {(#1-ccfbbelow)}
    \constcornerright {(#1-nor2.out-|#1-outvrt)}
    -- (#1-nor2.out-|#1-outvrt)
    %%
    (#1-nor2.in 1)
    \constcornerleft {(#1-nor1.in 2-|#1-invrt)}
    \varcornerupright {(#1-ccfbabove)}
    \constcornerright {(#1-nor1.out-|#1-outvrt)}
    -- (#1-nor1.out-|#1-outvrt)
    %%
    %% Drawing outputs
    %%
    (#1-nor1.out)
    -- (#1-q)
    %%
    (#1-nor2.out)
    -- (#1-nor2.out-|#1-q)
    coordinate (#1-qbar)
    %%
    %% Drawing inputs
    %%
    (#1-nor1.in 1)
    -- ++(-1,0)
    coordinate (#1-r)
    %%
    (#1-nor2.in 2)
    -- (#1-nor2.in 2-|#1-r)
    coordinate (#1-s)
    %%
    %% (#1-nor1.north) isn't working for some reason in markgeocoordinate
    %% while passing it as a argument
    %%
    (#1-nor1.north) coordinate (#1-north)
    (#1-nor2.south) coordinate (#1-south)
    %%
    \glvlmarkcoordinate {#1} {s} {(1,0)}
    \glvlmarkcoordinate {#1} {r} {(1,0)}
    \glvlmarkcoordinate {#1} {q} {(-1,0)}
    \glvlmarkcoordinate {#1} {qbar} {(-1,0)}
    %%
    \markgeocoordinate {#1}
    {(#1-north)} {(#1-south)}
    {(#1-s)} {(#1-q)}
}

\ctikzsubcircuitactivate{subctkgLvlSRLatch}

\newcommand\gLvlSRLatch[2] {
    \subctkgLvlSRLatch{#1} {#2}
}

\ctikzsubcircuitdef{subctkgLvlSRFlipFlop} {
    clk, s, r, q, qbar,
    bclk, bs, br, bq, bqbar%
} {
    \gLvlSRLatch {#1-srl} {s}
    %%
    (#1-srl-q-|#1-srl-r)
    ++(-1,0)
    node (#1-nor1) [nor port, anchor = out] {}
    %%
    (#1-srl-qbar-|#1-nor1.out)
    node (#1-nor2) [nor port, anchor = out] {}
    %%
    %% Connecting nor out to s and r
    %%
    (#1-nor1.out)
    \varcornerrightup {(#1-srl-pr)}
    -- (#1-srl-r)
    %%
    (#1-nor2.out)
    \varcornerrightdown {(#1-srl-ps)}
    -- (#1-srl-s)
    %%
    %% Markings for clk
    (#1-srl-center-|#1-nor1.in 1)
    coordinate (#1-tmp)
    ++(-0.5,0)
    coordinate (#1-clkbr)
    %%
    %% Drawing clk
    %%
    (#1-nor1.in 2)
    \constcornerleft {(#1-clkbr)}
    \constcornerdown {(#1-nor2.in 1)}
    -- (#1-nor2.in 1)
    %%
    (#1-clkbr)
    -- ++(-0.5,0)
    coordinate (#1-clk)
    %%
    %% Drawing inputs
    %%
    (#1-nor1.in 1)
    -- (#1-nor1.in 1-|#1-clk)
    coordinate (#1-s)
    %%
    (#1-nor2.in 2)
    -- (#1-nor2.in 2-|#1-clk)
    coordinate (#1-r)
    %%
    %% Marking outputs
    %%
    (#1-srl-q)
    coordinate (#1-q)
    %%
    (#1-srl-qbar)
    coordinate (#1-qbar)
    %%
    %% Marking b* p*
    %%
    \glvlmarkcoordinate {#1} {s} {(1,0)}
    \glvlmarkcoordinate {#1} {r} {(1,0)}
    \glvlmarkcoordinate {#1} {clk} {(1,0)}
    \glvlmarkcoordinate {#1} {q} {(-1,0)}
    \glvlmarkcoordinate {#1} {qbar} {(-1,0)}
    %%
    %% Geo coords
    %%
    \markgeocoordinate {#1}
    {(#1-srl-north)} {(#1-srl-south)}
    {(#1-s)} {(#1-q)}
    %%
    %%
}

\ctikzsubcircuitactivate{subctkgLvlSRFlipFlop}

\newcommand\gLvlSRFlipFlop[2] {
    \subctkgLvlSRFlipFlop{#1} {#2}
}

\ctikzsubcircuitdef{subctkgLvlNotGateRight} {
    north, south, east, west,
    northeast, northwest, southeast, southwest,
    center,
    in, out,
    bin, bout%
} {
    node (#1-nor)[nor port] {}
    %%
    %% in
    %%
    (#1-nor.in 1)
    -- (#1-nor.in 2)
    ($(#1-nor.in 1)!0.50!(#1-nor.in 2)$)
    -- ++(-\glvlbpingap,0)
    coordinate (#1-in)
    %%
    %% out
    (#1-nor.out)
    -- ++(\glvlbpingap,0)
    coordinate (#1-out)
    %%
    %% Marking b* p*
    %%
    \glvlmarkcoordinate {#1} {in} {(1,0)}
    \glvlmarkcoordinate {#1} {out} {(-1,0)}
    %%
    %% Geo coords
    %%
    \markgeocoordinate {#1}
    {(#1-nor.north)} {(#1-nor.south)}
    {(#1-in)} {(#1-out)}
    %%
}

\ctikzsubcircuitactivate{subctkgLvlNotGateRight}

\newcommand\gLvlNotGateRight[2] {
    \subctkgLvlNotGateRight{#1} {#2}
}

\ctikzsubcircuitdef{subctkgLvlNotGateLeft} {
    north, south, east, west,
    northeast, northwest, southeast, southwest,
    center,
    in, out,
    bin, bout%
} {
    node (#1-nor)[nor port, rotate = 180] {}
    %%
    %% in
    %%
    (#1-nor.in 1)
    -- (#1-nor.in 2)
    ($(#1-nor.in 1)!0.50!(#1-nor.in 2)$)
    -- ++(\glvlbpingap,0)
    coordinate (#1-in)
    %%
    %% out
    (#1-nor.out)
    -- ++(-\glvlbpingap,0)
    coordinate (#1-out)
    %%
    %% Marking b* p*
    %%
    \glvlmarkcoordinate {#1} {in} {(-1,0)}
    \glvlmarkcoordinate {#1} {out} {(1,0)}
    %%
    %% Geo coords
    %%
    \markgeocoordinate {#1}
    {(#1-nor.north)} {(#1-nor.south)}
    {(#1-out)} {(#1-in)}
    %%
}

\ctikzsubcircuitactivate{subctkgLvlNotGateLeft}

\newcommand\gLvlNotGateLeft[2] {
    \subctkgLvlNotGateLeft{#1} {#2}
}

\ctikzsubcircuitdef{subctkgLvlNotGateUp} {
    north, south, east, west,
    northeast, northwest, southeast, southwest,
    center,
    in, out,
    bin, bout%
} {
    node (#1-nor)[nor port, rotate = 90] {}
    %%
    %% in
    %%
    (#1-nor.in 1)
    -- (#1-nor.in 2)
    ($(#1-nor.in 1)!0.50!(#1-nor.in 2)$)
    -- ++(0,-\glvlbpingap)
    coordinate (#1-in)
    %%
    %% out
    (#1-nor.out)
    -- ++(0,\glvlbpingap)
    coordinate (#1-out)
    %%
    %% Marking b* p*
    %%
    \glvlmarkcoordinate {#1} {in} {(0,1)}
    \glvlmarkcoordinate {#1} {out} {(0,-1)}
    %%
    %% Geo coords
    %%
    \markgeocoordinate {#1}
    {(#1-out)} {(#1-in)}
    {(#1-nor.north)} {(#1-nor.south)}
    %%
}

\ctikzsubcircuitactivate{subctkgLvlNotGateUp}

\newcommand\gLvlNotGateUp[2] {
    \subctkgLvlNotGateUp{#1} {#2}
}

\ctikzsubcircuitdef{subctkgLvlNotGateDown} {
    north, south, east, west,
    northeast, northwest, southeast, southwest,
    center,
    in, out,
    bin, bout%
} {
    node (#1-nor)[nor port, rotate = -90] {}
    %%
    %% in
    %%
    (#1-nor.in 1)
    -- (#1-nor.in 2)
    ($(#1-nor.in 1)!0.50!(#1-nor.in 2)$)
    -- ++(0,\glvlbpingap)
    coordinate (#1-in)
    %%
    %% out
    (#1-nor.out)
    -- ++(0,-\glvlbpingap)
    coordinate (#1-out)
    %%
    %% Marking b* p*
    %%
    \glvlmarkcoordinate {#1} {in} {(0,-1)}
    \glvlmarkcoordinate {#1} {out} {(0,1)}
    %%
    %% Geo coords
    %%
    \markgeocoordinate {#1}
    {(#1-in)} {(#1-out)}
    {(#1-nor.south)} {(#1-nor.north)}
    %%
}

\ctikzsubcircuitactivate{subctkgLvlNotGateDown}

\newcommand\gLvlNotGateDown[2] {
    \subctkgLvlNotGateDown{#1} {#2}
}


\ctikzsubcircuitdef{subctkgLvlDFlipFlop} {
    north, south, east, west,
    northeast, northwest, southeast, southwest,
    center,
    d, clk, q, qbar,
    bd, bclk, bq, bqbar%
} {
    \gLvlSRFlipFlop {#1-srff} {clk}
    %%
    (#1-srff-r)
    %%
    (#1-srff-nor2.in 2)
    ++($(#1-srff-nor2.out)-(#1-srff-srl-nor2.in 2)$)
    node (#1-notnor) [nor port, anchor = out] {}
    %%
    %%
    (#1-notnor.in 2)
    ++($(#1-srff-nor2.out)-(#1-srff-srl-nor2.in 2)$)
    ++(1,0)
    coordinate (#1-d)
    (#1-d|-#1-notnor.in 2)
    coordinate (#1-d)
    %%
    ++(1,0)
    ($(#1-d|-#1-notnor.in 2)!0.50!(#1-notnor.in 2)$)
    coordinate (#1-dbr)
    %%
    (#1-dbr)
    \constcornerup {(#1-srff-s)}
    -- (#1-srff-s)
    %%
    %% Shorting the inputs of notnor
    %%
    ($(#1-notnor.in 1)!0.3!(#1-notnor.in 2)$)
    ++(-0.2,0)
    coordinate (#1-notnorbr)
    %%
    (#1-notnor.in 1)
    \varcornerleftdown {(#1-notnorbr)}
    -- (#1-notnorbr|-#1-notnor.in 2)
    %%
    (#1-notnor.in 2)
    -- (#1-d)
    %%
    %% Drawing notnor out to srff r
    %%
    (#1-notnor.out)
    \varcornerrightdown {(#1-srff-pr)}
    -- (#1-srff-r)
    %%
    (#1-srff-clk)
    coordinate (#1-clk)
    %%
    (#1-srff-q)
    coordinate (#1-q)
    %%
    (#1-srff-qbar)
    coordinate (#1-qbar)
    %%
    %% Marking b* p*
    %%
    \glvlmarkcoordinate {#1} {d} {(1,0)}
    \glvlmarkcoordinate {#1} {clk} {(1,0)}
    \glvlmarkcoordinate {#1} {q} {(-1,0)}
    \glvlmarkcoordinate {#1} {qbar} {(-1,0)}
    %%
    %% Geo coords
    %%
    \markgeocoordinate {#1}
    {(#1-srff-north)} {(#1-srff-south)}
    {(#1-d)} {(#1-q)}
    %%
    %%
}

\ctikzsubcircuitactivate{subctkgLvlDFlipFlop}

\newcommand\gLvlDFlipFlop[2] {
    \subctkgLvlDFlipFlop{#1} {#2}
}

\ctikzsubcircuitdef{subctkgLvlDFlipFlopSR} {
    north, south, east, west,
    northeast, northwest, southeast, southwest,
    center,
    d, clk, q, qbar, rst,
    bd, bclk, bq, bqbar, brst%
} {
    \gLvlDFlipFlop {#1-dff} {clk}
    (#1-dff-notnor.in 2)
    ++($(#1-dff-notnor.out)-(#1-dff-srff-nor2.in 2)$)
    node (#1-rstnor) [nor port, anchor = out] {}
    %%
    %% Drawing rst
    %%
    (#1-rstnor.in 2)
    \constcornerleft {(#1-rstnor.in 2) ++(-0.75,-1)}
    -- ++(0,-1)
    coordinate (#1-rst)
    %%
    (#1-rstnor.in 1)
    -- ++(-1,0)
    coordinate (#1-d)
    %%
    %% Marking the topmost point, so as to make dffsr's geo choords
    %% symmetric along x axis
    %%
    (#1-dff-north)
    ++($(#1-dff-south)-(#1-dff-south|-#1-rst)$)
    coordinate (#1-topmostpoint)
    %%
    %% Drawing rstnor out to dff d
    %%
    (#1-rstnor.out)
    \varcornerrightdown {(#1-dff-pd)}
    -- (#1-dff-d)
    %%
    (#1-dff-clk)
    coordinate (#1-clk)
    %%
    (#1-dff-q)
    coordinate (#1-q)
    %%
    (#1-dff-qbar)
    coordinate (#1-qbar)
    %%
    \glvlmarkcoordinate {#1} {d} {(1,0)}
    \glvlmarkcoordinate {#1} {clk} {(1,0)}
    \glvlmarkcoordinate {#1} {rst} {(0,1)}
    \glvlmarkcoordinate {#1} {q} {(-1,0)}
    \glvlmarkcoordinate {#1} {qbar} {(-1,0)}
    \glvlmarkcoordinate {#1} {topmostpoint} {(0,-1)}
    %%
    \markgeocoordinate {#1}
    {(#1-topmostpoint)} {(#1-rst)}
    {(#1-d)} {(#1-q)}
    %%
}

\ctikzsubcircuitactivate{subctkgLvlDFlipFlopSR}

\newcommand\gLvlDFlipFlopSR[2] {
    \subctkgLvlDFlipFlopSR{#1} {#2}
}

\ctikzsubcircuitdef{subctkgLvlMSFlipFlop} {
    north, south, east, west,
    northeast, northwest, southeast, southwest,
    center,
    d, reclk, feclk, q, qbar, rst,
    bd, breclk, bfeclk, bq, bqbar, brst%
} {
    \gLvlDFlipFlopSR {#1-master} {d}
    %%
    ($(#1-master-q)!0.50!(#1-master-qbar)$)
    ++(1,0)
    \gLvlSRFlipFlop {#1-slave} {clk}
    %%
    (#1-master-q)
    \varcornerrightup {(#1-slave-ps)}
    -- (#1-slave-s)
    %%
    (#1-master-qbar)
    \varcornerrightdown {(#1-slave-pr)}
    -- (#1-slave-r)
    %%
    %% Marking coords for reclk, feclk and rst
    %%
    %% rst
    %%
    (#1-slave-south)
    ++ (0,-5)
    coordinate (#1-rstheight)
    %%
    (#1-master-rst)
    ++(0,-1)
    coordinate (#1-rstbendheight)
    %%
    (#1-slave-srl-south)
    coordinate (#1-rstvrt)
    %%
    %% clks
    %%
    (#1-slave-north)
    ++ ($(#1-slave-south)-(#1-rstheight)$)
    coordinate (#1-clkheight)
    %%
    (#1-master-rstnor.center)
    coordinate (#1-reclkvrt)
    %%
    (#1-slave-north)
    ++ ($(#1-slave-south)-(#1-slave-south|-#1-rstbendheight)$)
    coordinate (#1-feclkbendheight)
    %%
    (#1-slave-clk)
    ++(-1,0)
    coordinate (#1-feclkbendvrt)
    %%
    %% Drawing clk lines
    %%
    (#1-master-clk)
    \constcornerleft {(#1-reclkvrt|-#1-clkheight)}
    -- (#1-reclkvrt|-#1-clkheight)
    coordinate (#1-reclk)
    ++ (2,0)
    coordinate (#1-feclk)
    %%
    (#1-slave-clk)
    \constcornerleft {(#1-feclkbendheight-|#1-feclkbendvrt)}
    \constcornerup {(#1-feclkbendheight-|#1-feclk)}
    \constcornerleft {(#1-feclk)}
    -- (#1-feclk)
    %%
    %% Drawing rst line
    %%
    (#1-master-rst)
    \constcornerdown {(#1-rstbendheight-|#1-rstvrt)}
    \constcornerright {(#1-rstvrt|-#1-rstheight)}
    -- (#1-rstvrt|-#1-rstheight)
    coordinate (#1-rst)
    %%
    %% Marking d, q, qbar
    %%
    (#1-master-d)
    coordinate (#1-d)
    %%
    (#1-slave-q)
    coordinate (#1-q)
    %%
    (#1-slave-qbar)
    coordinate (#1-qbar)
    %%
    %% Marking b* p*
    %%
    \glvlmarkcoordinate {#1} {d}     {(1,0)}
    \glvlmarkcoordinate {#1} {reclk} {(0,-1)}
    \glvlmarkcoordinate {#1} {feclk} {(0,-1)}
    \glvlmarkcoordinate {#1} {q}     {(-1,0)}
    \glvlmarkcoordinate {#1} {qbar}  {(-1,0)}
    \glvlmarkcoordinate {#1} {rst}   {(0,1)}
    %%
    %% Marking Geo coords
    %%
    \markgeocoordinate {#1}
    {(#1-reclk)} {(#1-rst)}
    {(#1-d)} {(#1-q)}
}

\ctikzsubcircuitactivate{subctkgLvlMSFlipFlop}

\newcommand\gLvlMSFlipFlop[2] {
    \subctkgLvlMSFlipFlop{#1} {#2}
}
