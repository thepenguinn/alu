\ctikzsubcircuitdef{subctkclkGen} {
    clk, feclk, notdreclk, notdfeclk, notreclk,
    bclk, bfeclk, bnotdreclk, bnotdfeclk, bnotreclk%
} {
    node (#1) [clkGen]{}%
    \markcoordinate {#1} {clk}       {lpin 1}
    \markcoordinate {#1} {feclk}     {rpin 1}
    \markcoordinate {#1} {notdreclk} {rpin 2}
    \markcoordinate {#1} {notdfeclk} {rpin 3}
    \markcoordinate {#1} {notreclk}  {rpin 4}
    (#1-bfeclk) node [circleinv, anchor = left] {}
}

\ctikzsubcircuitdef{subctkrstGen} {
    on, notreclk, notdfeclk, rstsig, fsrq,
    bon, bnotreclk, bnotdfeclk, brstsig, bfsrq%
} {
    node (#1) [rstGen]{}%
    \markcoordinate {#1} {on}        {lpin 1}
    \markcoordinate {#1} {notreclk}  {tpin 2}
    \markcoordinate {#1} {notdfeclk} {tpin 3}
    \markcoordinate {#1} {rstsig}    {rpin 1}
    \markcoordinate {#1} {fsrq}      {rpin 2}
}

\ctikzsubcircuitdef{subctkhaltUnit} {
    notreclk, notdfeclk, notdreclk, rgfsrq, muxlast, reclk,
    bnotreclk, bnotdfeclk, bnotdreclk, brgfsrq, bmuxlast, breclk%
} {
    node (#1) [haltUnit]{}%
    \markcoordinate {#1} {notreclk}  {tpin 1}
    \markcoordinate {#1} {notdfeclk} {tpin 2}
    \markcoordinate {#1} {notdreclk} {tpin 3}
    \markcoordinate {#1} {rgfsrq}    {bpin 3}
    \markcoordinate {#1} {muxlast}   {bpin 4}
    \markcoordinate {#1} {reclk}     {rpin 1}
    \markcoordinate {#1} {fsrq}      {rpin 2}
    (#1-breclk) node [circleinv, anchor = left] {}
    (#1-bmuxlast) node [circleinv, anchor = top] {}
}

\ctikzsubcircuitactivate{subctkclkGen}
\ctikzsubcircuitactivate{subctkrstGen}
\ctikzsubcircuitactivate{subctkhaltUnit}

\newcommand\clkGen[3] {
    \subctkclkGen{#1} {#2}
    (#1.center) node[]{#3}
}

\newcommand\rstGen[3] {
    \subctkrstGen{#1} {#2}
    (#1.center) node[]{#3}
}

\newcommand\haltUnit[3] {
    \subctkhaltUnit{#1} {#2}
    (#1.center) node[]{#3}
}

\ctikzsubcircuitdef{subctkInitCircuit} {
    north, south, east, west,
    northeast, northwest, southeast, southwest,
    center,
    clk, on, muxlast, feclk, reclk, rstsig%
} {
    \clkGen {#1-cg} {clk} {}
    (#1-cg-clk)
    ++(0,-6)
    \rstGen {#1-rg} {on} {}
    (#1-rg-rstsig)
    %%
    ++(3,0.25)
    \haltUnit {#1-hu} {rgfsrq} {}
    %%
    %% Marking heights for notreclk notdfeclk branches
    %%
    (#1-cg-notreclk-|#1-hu-notreclk)
    ++(0,-1)
    coordinate (#1-notreclkbrheight)
    ++($(#1-cg-notreclk)-(#1-cg-notdfeclk)$)
    coordinate (#1-notdfeclkbrheight)
    %%
    %% Drawing output of clk gen
    %%
    (#1-cg-notreclk)
    \constcornerright {(#1-hu-notreclk)}
    -- (#1-hu-notreclk)
    %%
    (#1-cg-notdfeclk)
    \aroundcornertillrightdown {($(#1-hu-notreclk)-(#1-hu-notdfeclk)$)}
    {(#1-cg-notreclk-|#1-hu-notreclk) ++(0,-\cornerbase)}
    {(#1-hu-notdfeclk)} {(0,1)}
    -- (#1-hu-notdfeclk)
    %%
    (#1-cg-notdreclk)
    \aroundcornertillrightdown {($(#1-hu-notreclk)-(#1-hu-notdreclk)$)}
    {(#1-cg-notreclk-|#1-hu-notreclk) ++(0,-\cornerbase)}
    {(#1-hu-notdreclk)} {(0,1)}
    -- (#1-hu-notdreclk)
    %%
    %% Drawing clk to rst gen
    %%
    (#1-notdfeclkbrheight-|#1-hu-notdfeclk)
    \constcornerleft {(#1-rg-notdfeclk)}
    -- (#1-rg-notdfeclk)
    %%
    (#1-notreclkbrheight-|#1-hu-notreclk)
    \aroundcornertillleftdown {($(#1-rg-notreclk)-(#1-rg-notdfeclk)$)}
    {(#1-notdfeclkbrheight-|#1-rg-notdfeclk) ++(0,-\cornerbase)}
    {(#1-rg-notreclk)} {(0,1)}
    -- (#1-rg-notreclk)
    %%
    %% Drawing rgfsrq
    %%
    (#1-rg-fsrq)
    \constcornerright {(#1-hu-rgfsrq)}
    -- (#1-hu-rgfsrq)
    %%
    %% Marking things for drawing outputs
    %%
    (#1-cg-feclk-|#1-hu-reclk)
    ++ (3.5,0)
    coordinate (#1-feclkheight)
    ++ (0,-1)
    coordinate (#1-reclkheight)
    ++ (0,-1)
    coordinate (#1-rstsigheight)
    %%
    %% Drawing the ouputs
    %%
    (#1-cg-feclk)
    -- (#1-feclkheight)
    -- ++(3,0)
    coordinate (#1-feclk)
    %%
    (#1-hu-reclk)
    \varcornerrightup {(#1-reclkheight)}
    -- (#1-reclkheight-|#1-feclk)
    coordinate (#1-reclk)
    %%
    (#1-rg-rstsig)
    \aroundcornertillrightup {($(#1-rg-rstsig-|#1-hu-reclk)-(#1-hu-reclk)$)}
    {(#1-reclkheight)}
    {(#1-rstsigheight)} {(1,0)}
    -- (#1-rstsigheight-|#1-feclk)
    coordinate (#1-rstsig)
    %%
    %% Drawing inputs
    %%
    (#1-cg-clk)
    -- ++(-2,0)
    coordinate (#1-clk)
    %%
    (#1-rg-on)
    -- (#1-rg-on-|#1-clk)
    coordinate (#1-on)
    %%
    %% Drawing muxlast
    %%
    (#1-hu-muxlast)
    -- ++(0,-3)
    coordinate (#1-muxlast)
    \markgeocoordinate {#1}
    {(#1-cg.north)} {(#1-muxlast)}
    {(#1-clk)} {(#1-feclk)}
}

\ctikzsubcircuitactivate{subctkInitCircuit}

\newcommand\initCircuit[2]{
    \subctkInitCircuit {#1} {#2}
}

\newcommand\labelinitCircuit[4]{
    (#1-cg.center) node[] {#2}
    (#1-rg.center) node[] {#3}
    (#1-hu.center) node[] {#4}
}
