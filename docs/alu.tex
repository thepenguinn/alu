\documentclass[a4paper, 10pt]{article}

\usepackage[siunitx]{circuitikz}
\usepackage[margin = 1in]{geometry}
\usepackage{rotating}
\usepackage{ifthen}

\usetikzlibrary{intersections}

\def\cornerhypo{0.15}
\def\cornerbase{0.5cm}
\def\cV{|-}
\def\cH{-|}

% to get rid of lines not properly joining after setting
% a coordinate at some other position and continue drawing
\newcommand\slightleft[0] {
    -- ++(-0.005,0)
}

\newcommand\slightright[0] {
    -- ++(0.005,0)
}

\newcommand\slightup[0] {
    -- ++(0,0.005)
}

\newcommand\slightdown[0] {
    -- ++(0,-0.005)
}

\newcommand\constcorner[2] {
    coordinate (LCJTMP)
    #2 coordinate (finaltmp)

    (LCJTMP#1finaltmp) coordinate (LCVTMP)
    ($(LCVTMP)!\cornerbase!0:(finaltmp)$) coordinate (SCBTMP)
    ($(LCVTMP)!\cornerbase!0:(LCJTMP)$) coordinate (FCBTMP)

    (LCJTMP) -- (FCBTMP) -- (SCBTMP)
}

\newcommand\constcornerright[1] {
    \slightright
    \constcorner {\cH} {#1}
}

\newcommand\constcornerleft[1] {
    \slightleft
    \constcorner {\cH} {#1}
}

\newcommand\constcornerup [1] {
    \slightup
    \constcorner {\cV} {#1}
}

\newcommand\constcornerdown [1] {
    \slightdown
    \constcorner {\cV} {#1}
}

%%
\newcommand\constcornerhoz [1] {
    \constcorner {\cH} {#1}
}

\newcommand\constcornervrt [1] {
    \constcorner {\cV} {#1}
}

\newcommand\markvarcornerpos[2] {
    coordinate (LCJTMP)
    #2 coordinate (SCBTMP)

    (LCJTMP#1SCBTMP) coordinate (LCVTMP)
    ($(SCBTMP)!0.1cm!-45:(LCVTMP)$) coordinate (cornedgtmp)
    (intersection of LCJTMP--LCVTMP and SCBTMP--cornedgtmp)
    coordinate (FCBTMP)
}

\newcommand\markvarcornerneg[2] {
    coordinate (LCJTMP)
    #2 coordinate (SCBTMP)

    (LCJTMP#1SCBTMP) coordinate (LCVTMP)
    ($(SCBTMP)!0.1cm!+45:(LCVTMP)$) coordinate (cornedgtmp)
    (intersection of LCJTMP--LCVTMP and SCBTMP--cornedgtmp)
    coordinate (FCBTMP)
}

\newcommand\varcornerpos[2] {

    \markvarcornerpos {#1} {#2}
    (LCJTMP) -- (FCBTMP) -- (SCBTMP)
}

\newcommand\varcornerneg[2] {

    \markvarcornerneg {#1} {#2}
    (LCJTMP) -- (FCBTMP) -- (SCBTMP)

}

\newcommand\varcornerupright[1] {
    \slightup
    \varcornerneg {\cV} {#1}
}
\newcommand\varcornerdownleft[1] {
    \slightdown
    \varcornerneg {\cV} {#1}
}

\newcommand\varcornerupleft[1] {
    \slightup
    \varcornerpos {\cV} {#1}
}
\newcommand\varcornerdownright[1] {
    \slightdown
    \varcornerpos {\cV} {#1}
}

\newcommand\varcornerrightdown[1] {
    \slightright
    \varcornerneg {\cH} {#1}
}
\newcommand\varcornerleftup[1] {
    \slightleft
    \varcornerneg {\cH} {#1}
}

\newcommand\varcornerrightup[1] {
    \slightright
    \varcornerpos {\cH} {#1}
}
\newcommand\varcornerleftdown[1] {
    \slightleft
    \varcornerpos {\cH} {#1}
}

%%
\newcommand\varcornervrtneg[1] {
    \varcornerneg {\cV} {#1}
}

\newcommand\varcornervrtpos[1] {
    \varcornerpos {\cV} {#1}
}

\newcommand\varcornerhozneg[1] {
    \varcornerneg {\cH} {#1}
}

\newcommand\varcornerhozpos[1] {
    \varcornerpos {\cH} {#1}
}

\newcommand\markaroundcornerpos[3] {
    \markvarcornerpos {#2} {#3}

    ($(SCBTMP)!#1cm!90:(FCBTMP)$) coordinate (bevltmp)
    ($(SCBTMP)!#1cm!90:(LCVTMP)$) coordinate (nexsidetmp)
    (bevltmp#2nexsidetmp) coordinate (SCBTMP)
    (LCJTMP#2SCBTMP) coordinate (LCVTMP)

    ($(SCBTMP)!0.1cm!-45:(LCVTMP)$) coordinate (cornedgtmp)
    (intersection of LCJTMP--LCVTMP and SCBTMP--cornedgtmp)
    coordinate (FCBTMP)

}

\newcommand\markaroundcornerneg[3] {
    \markvarcornerneg {#2} {#3}

    ($(SCBTMP)!#1cm!-90:(FCBTMP)$) coordinate (bevltmp)
    ($(SCBTMP)!#1cm!-90:(LCVTMP)$) coordinate (nexsidetmp)
    (bevltmp#2nexsidetmp) coordinate (SCBTMP)
    (LCJTMP#2SCBTMP) coordinate (LCVTMP)

    ($(SCBTMP)!0.1cm!+45:(LCVTMP)$) coordinate (cornedgtmp)
    (intersection of LCJTMP--LCVTMP and SCBTMP--cornedgtmp)
    coordinate (FCBTMP)

}

\newcommand\aroundcornerpos[3] {

    \markaroundcornerpos {#1} {#2} {#3}
    (LCJTMP) -- (FCBTMP) -- (SCBTMP)
}

\newcommand\aroundcornerneg[3] {

    \markaroundcornerneg {#1} {#2} {#3}
    (LCJTMP) -- (FCBTMP) -- (SCBTMP)

}

\newcommand\aroundcornerupright[2] {
    \slightup
    \aroundcornerneg {#1} {\cV} {#2}
}
\newcommand\aroundcornerdownleft[2] {
    \slightdown
    \aroundcornerneg {#1} {\cV} {#2}
}

\newcommand\aroundcornerupleft[2] {
    \slightup
    \aroundcornerpos {#1} {\cV} {#2}
}
\newcommand\aroundcornerdownright[2] {
    \slightdown
    \aroundcornerpos {#1} {\cV} {#2}
}

\newcommand\aroundcornerrightdown[2] {
    \slightright
    \aroundcornerneg {#1} {\cH} {#2}
}
\newcommand\aroundcornerleftup[2] {
    \slightleft
    \aroundcornerneg {#1} {\cH} {#2}
}

\newcommand\aroundcornerrightup[2] {
    \slightright
    \aroundcornerpos {#1} {\cH} {#2}
}
\newcommand\aroundcornerleftdown[2] {
    \slightleft
    \aroundcornerpos {#1} {\cH} {#2}
}

% \ctikzsubcircuitdef{msFlop} {EC, IEC, D, RST, Q} {
% \ctikzsubcircuitdef{test} {EC} {
%     coordinate(#1-EC)
%     \corneranticlk {++(0,4)}
%     \corneranticlk {++(4,0)}
%     -- ++(4,0)
% }

\tikzset{fullAdder/.style = {muxdemux, muxdemux def = {
    NL = 3, NR = 3, NB = 0, NT = 0,
    Lh = 3, Rh = 3,
    w = 5 },
draw only right pins = {1, 3} }
}

\tikzset{aluInit/.style = {muxdemux, muxdemux def = {
    NL = 2, NR = 2, NB = 6, NT = 2,
    Lh = 3, Rh = 3,
    % Lh = 5.35, Rh = 3,
    w = 5 },
draw only top pins = {1},
draw only bottom pins = {5, 6}, }
}


\tikzset{logicOp/.style = {muxdemux, muxdemux def = {
    NL = 2, NR = 1, NB = 0, NT = 0,
    Lh = 3, Rh = 3,
    w = 5
    },
    }
}

\tikzset{msFlipFlop/.style = {muxdemux, muxdemux def = {
    NL = 2, NR = 2, NB = 0, NT = 6,
    Lh = 3, Rh = 3,
    w = 5
    },
    draw only top pins = {1,2},
    }
}

\tikzset{mux08/.style = {muxdemux, muxdemux def = {
    NL = 12, NR = 3, NB = 5, NT = 0,
    Lh = 13, Rh = 7.8,
    % Lh = 10, Rh = 6.5,
    inset Lh = 4.5, inset Rh = 2.75,
    % inset Lh = 3.5, inset Rh = 1.75,
    inset w = 1,
    w = 4.5,
    % w = 3.5,
    square pins = 1
},
draw only left pins={1,2,5-6,8-11},
draw only right pins={1-2},
draw only bottom pins={2-4}
}
}

%  node [muxdemux, rotate = -90, muxdemux def = {NL=10, NR=3, NT=0, NB=4,
%  w = 2.5, Lh = 10, Rh = 6.5, inset Lh = 3.5, inset w = .75, inset Rh = 1.75,
%  square pins=1
%  },
%  draw only left pins={2-9},
%  draw only right pins={1-2},
%  draw only bottom pins={2-4}
%  ]
%  (mux) {
%      \begin{turn}{90}
%          \texttt{MUX8}
%      \end{turn}
%  }

%  % (mux.rpin 3) -- ++(1,1)

\def\fulladdername{\texttt{ADDER}}
% \def\logicopstyle{\texttt{}}


% \ctikzsubcircuitdef{onebitalu} {ina, inb, eclk, ieclk, rst, op0, op1, op2, regout, aluout} {
\ctikzsubcircuitdef{onebitalu} {L} {
    coordinate (#1-L)
    node [fullAdder] (#1-flad) {\fulladdername}
}

\ctikzsubcircuitdef{subctkfullAdder} {
    A, B, Cin, Cout, Sum,
    bA, bB, bCin, bCout, bSum%
} {
    node (#1) [fullAdder, anchor = lpin 1]{}%
    coordinate (#1-B)      at (#1.lpin 1)
    coordinate (#1-A)      at (#1.lpin 3)
    coordinate (#1-Cin)    at (#1.lpin 2)
    coordinate (#1-Sum)    at (#1.rpin 3)
    coordinate (#1-Cout)   at (#1.rpin 1)%
    coordinate (#1-bB)    at (#1.blpin 1)
    coordinate (#1-bA)    at (#1.blpin 3)
    coordinate (#1-bCin)  at (#1.blpin 2)
    coordinate (#1-bSum)  at (#1.brpin 3)
    coordinate (#1-bCout) at (#1.brpin 1)
}

\ctikzsubcircuitdef{subctkaluInit} {
    B, Cin, Op, Mux, Rst, Bout, Cout,
    bB, bCin, bOp, bMux, bRst, bBout, bCout%
} {
    node (#1) [aluInit, anchor = lpin 1]{}%
    coordinate (#1-B)      at (#1.lpin 1)
    coordinate (#1-Cin)    at (#1.lpin 2)
    coordinate (#1-Bout)   at (#1.rpin 1)
    coordinate (#1-Cout)   at (#1.rpin 2)
    coordinate (#1-Mux)    at (#1.bpin 5)
    coordinate (#1-Op)     at (#1.bpin 6)
    coordinate (#1-Rst)    at (#1.tpin 1)%
    coordinate (#1-bB)    at (#1.blpin 1)
    coordinate (#1-bCin)  at (#1.blpin 2)
    coordinate (#1-bBout) at (#1.brpin 1)
    coordinate (#1-bCout) at (#1.brpin 2)
    coordinate (#1-bMux)  at (#1.bbpin 5)
    coordinate (#1-bOp)   at (#1.bbpin 6)
    coordinate (#1-bRst)  at (#1.btpin 1)
}

\ctikzsubcircuitdef{subctkmsFlipFlop} {
    D, Rst, Eclk, Ieclk, Q, Qbar,
    bD, bRst, bEclk, bIeclk, bQ, bQbar%
} {
    node (#1) [msFlipFlop, anchor = lpin 1]{}%
    coordinate (#1-D)       at (#1.lpin 2)
    coordinate (#1-Rst)     at (#1.lpin 1)
    coordinate (#1-Eclk)    at (#1.tpin 1)
    coordinate (#1-Ieclk)   at (#1.tpin 2)
    coordinate (#1-Q)       at (#1.rpin 2)
    coordinate (#1-Qbar)    at (#1.rpin 1)%
    coordinate (#1-bD)     at (#1.blpin 2)
    coordinate (#1-bRst)   at (#1.blpin 1)
    coordinate (#1-bEclk)  at (#1.btpin 1)
    coordinate (#1-bIeclk) at (#1.btpin 2)
    coordinate (#1-bQ)     at (#1.brpin 2)
    coordinate (#1-bQbar)  at (#1.brpin 1)%
}

\ctikzsubcircuitactivate{test}
\ctikzsubcircuitactivate{onebitalu}
\ctikzsubcircuitactivate{subctkfullAdder}
\ctikzsubcircuitactivate{subctkaluInit}
\ctikzsubcircuitactivate{subctkmsFlipFlop}

\newcommand\fullAdder[3] {
    \subctkfullAdder{#1} {#2}
    (#1.center) node[]{#3}
}

\newcommand\aluInit[3] {
    \subctkaluInit{#1} {#2}
    (#1.center) node[]{#3}
}

\newcommand\msFlipFlop[3] {
    \subctkmsFlipFlop{#1} {#2}
    (#1.center) node[]{#3}
}
\begin{document}

\section{1 bit ALU}

%  % \ctikzset{muxdemuxes/thickness = 3, multipoles/external pins thickness = 1.5, bipoles/tline/width = 3}

%  \draw[semithick]

%  node [muxdemux, rotate = -90, muxdemux def = {NL=10, NR=3, NT=0, NB=4,
%  w = 2.5, Lh = 10, Rh = 6.5, inset Lh = 3.5, inset w = .75, inset Rh = 1.75,
%  square pins=1
%  },
%  draw only left pins={2-9},
%  draw only right pins={1-2},
%  draw only bottom pins={2-4}]
%  (mux) {
%      \begin{turn}{90}
%          \texttt{MUX8}
%      \end{turn}
%  }

%  % (mux.rpin 3) -- ++(1,1)
%  ;

% \tikzset{blockdef-above/.style={
%     {Straight Barb[harpoon, right, length=-0.2cm]}-{Straight Barb[harpoon, left, length=-0.2cm]},
%     black,
%     }}

% \tikzset{barbarrow/.style = {> = {Straight Barb[right, length = 5pt, width = 5pt]}}}

\begin{circuitikz}[american]

    \draw [line join = round]
    (0,0)

    \fullAdder{flad}{Cin} {\texttt{\fulladdername}}
    (flad-Cout)
    \constcornerhoz {++(0.75,1)} -- ++(0.25,0)

    \aluInit{ainit}{Cin} {\texttt{ALU INIT}}
    (ainit-Cout)
    \constcornerhoz {++(0.75,-1)} -- ++(0.25,0)

    \msFlipFlop{msff}{D} {\texttt{MS FLIPFLOP}}

    (flad-B) ++(-0.75,0)
    coordinate (fladBinvrt)

    (ainit-Bout) ++(0,2)
    coordinate (ainitBoutheight)

    (ainit-Bout)
    \constcornerright {++(0.75,1)}
    \constcornerup {(ainitBoutheight)}
    \constcornerleft {(fladBinvrt)}
    \constcornerdown {(flad-B)}
    -- (flad-B)

    % TESTING
    % (flad-Cout) ++(4,-2)

    % node (testmux) [mux08, anchor = lpin 1]{\texttt{MUX}}%
    ;

\end{circuitikz}

\begin{circuitikz}

    \draw [line join = round]
    (0,0) ++(4,0)
    coordinate (start)

    \varcornerleftdown {++(-4,-2)}
    coordinate (end)
    -- ++(0,-4)
    coordinate (acend)

    (start) ++(0,0.75)

    \markcorneraroundpos {0.75} {\cH} {(end)}

    -- (SCBTMP|-acend)
    -- ++(0.75,0)
    \slightup

    (start)
    -- ++(0,0.75)
    ;

\end{circuitikz}

% \begin{circuitikz}[american]
%
%     \tikzset{barbarrow/.style = {> = {Straight Barb[left, length = 5pt, width = 5pt]}}}
%
%     \draw
%     (0,0) -- ++(1,1)
%     \test {hai} {EC}
%     ;
%
% \end{circuitikz}

\end{document}
